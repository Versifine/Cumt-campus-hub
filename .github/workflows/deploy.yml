name: Deploy to Tencent Cloud

on:
  push:
    branches: [ "main" ]  # 只有推送到 main 分支时才触发

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. 拉取代码
    - uses: actions/checkout@v4

    # 2. 编译前端 Vue
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Build Frontend
      run: |
        cd apps/web
        npm install
        npm run build
        
    # 3. 编译后端 Go
    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.22'

    - name: Build Binary
      run: |
        GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -o server_linux ./server
        gzip -f server_linux

    - name: Package Frontend
      run: |
        cd apps/web/dist
        tar -czf ../../../frontend.tar.gz .

    # 4. 传送文件 (前后端分开传)
    - name: Create directories on server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        timeout: 30s
        use_insecure_cipher: true
        script: |
          mkdir -p /var/www/cumt-hub/dist
          mkdir -p /root/cumt-hub

    - name: Deploy Frontend
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "frontend.tar.gz"
        target: "/root/cumt-hub/"
        timeout: 120s
        debug: true
        use_insecure_cipher: true

    - name: Deploy Backend
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "server_linux.gz"
        target: "/root/cumt-hub/"
        timeout: 120s
        debug: true
        use_insecure_cipher: true

    # 5. 解压并重启服务
    - name: Restart Backend
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        use_insecure_cipher: true
        script: |
          cd /root/cumt-hub/
          # 解压后端
          gzip -df server_linux.gz
          chmod +x server_linux
          # 解压前端
          rm -rf /var/www/cumt-hub/dist/*
          tar -xzf frontend.tar.gz -C /var/www/cumt-hub/dist/
          rm frontend.tar.gz
          # 设置权限
          chmod -R 755 /var/www/cumt-hub
          # 重启服务
          systemctl restart cumt-hub
          echo "Deployment Success!"