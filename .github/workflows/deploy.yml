name: Deploy to Tencent Cloud

on:
  push:
    branches: [ "main" ]  # 只有推送到 main 分支时才触发

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. 拉取代码
    - uses: actions/checkout@v4

    # 2. 编译前端 Vue
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Build Frontend
      run: |
        cd apps/web
        npm install
        npm run build
        
    # 3. 编译后端 Go
    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.22'

    - name: Build Binary
      run: |
        GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -o server_linux ./server

    # 4. 传送文件 (前后端分开传)
    - name: Deploy Frontend
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "apps/web/dist/*"
        target: "/var/www/cumt-hub/dist/"
        strip_components: 3

    - name: Deploy Backend
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "server_linux"
        target: "/root/cumt-hub/"

    # 5. 重启后端服务 (前端文件覆盖即生效)
    - name: Restart Backend
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          chmod +x /root/cumt-hub/server_linux
          systemctl restart cumt-hub
          # 给前端文件夹设置权限，防止 403 Forbidden
          chmod -R 755 /var/www/cumt-hub
          echo "Deployment Success!"